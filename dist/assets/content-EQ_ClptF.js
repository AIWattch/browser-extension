const a=function(t){return new Promise(function(s,o){try{chrome.storage.local.get([t]).then(n=>{Object.keys(n).length!==0?s(n[t]):o("emptyKey")})}catch(n){o(n)}})},f=function(t){return new Promise(function(s,o){try{chrome.storage.local.set(t).then(n=>{s(n)})}catch(n){o(n)}})},h=new MutationObserver((t,s)=>{for(const o of t)o.type==="childList"&&o.addedNodes.forEach(n=>{if(typeof n.className=="string"&&n.className==="fixed right-4 top-8 my-2 flex max-h-[90vh] flex-col-reverse space-y-2 space-y-reverse overflow-y-auto px-2 py-4"){const e=n.innerText.replace("ChatGPT",""),c=document.querySelectorAll("article"),r=c[c.length-2],u=[];u.push({type:"inputTokens",content:r.innerText}),u.push({type:"outputTokens",content:e}),g(u)}})});h.observe(document.body,{childList:!0,subtree:!0});function g(t){console.log("ChatGPT output finished");const s=[];t.forEach(o=>{const n=d(o);s.push(n)}),Promise.all(s).then(o=>{let n={};o.forEach(e=>{let c=Object.keys(e)[0],r=Object.values(e)[0];n[c]=r}),y(n).then(e=>e).then(e=>(f({user:e}),e)).then(e=>{m(e)})}).catch(o=>{console.error(o)})}const d=function(t){return new Promise(function(s,o){t.content;const n=t.content.length,e=t.type;a("config").then(c=>{console.log(c);const r=n/c.charsPerToken.value;a("user").then(u=>{const i=u[e],l=Math.ceil(i+r);s({[e]:l})})})})},y=function(t){return new Promise(function(s,o){const n=t.inputTokens,e=t.outputTokens;a("config").then(c=>(n*c.inputFactor.value+e*c.outputFactor.value)*c.PUE.value*c.gridFactor.value).then(c=>{t.totalEmissions=c,s(t)})})},k=function(){return new Promise(function(t,s){const o="user-stats",n=document.querySelector(`#${o}`);if(n){const e=n.querySelector("span");t([n,e])}else{const e=document.createElement("div"),c=document.createElement("span");e.id=o,e.insertAdjacentElement("afterbegin",c),document.body.insertAdjacentElement("afterbegin",e),t([e,c])}})};function m(t){window.location.href.startsWith("chrome-extension://")||k().then(s=>{const o=s[0],n=s[1];a("ui").then(r=>{o.style.top=r.yPos,o.style.left=r.xPos}).catch(r=>{r==="emptyKey"?p("ui"):console.error(r)}),E(o);const e=(t.totalEmissions/400).toString().substring(0,4);if(n.textContent=`Input tokens: ${t.inputTokens} \r
`,n.textContent+=`Output tokens: ${t.outputTokens} \r
`,n.textContent+=`Total emissions: ${t.totalEmissions.toString().substring(0,6)} gCO2e \r
`,n.textContent+=`ðŸš— Your AI drive: ${e} miles\r
`,!document.querySelector(".reset-btn")){const r=document.createElement("img");r.className="reset-btn",r.src=chrome.runtime.getURL("../assets/reset.svg"),r.addEventListener("mouseup",function(u){const i={};i.user={},i.user.inputTokens=0,i.user.outputTokens=0,i.user.totalEmissions=0,f(i).then(l=>{console.log("cleared storage OK"),m(i.user)}).catch(l=>{console.log(l)})},!0),o.appendChild(r)}})}const T=function(){return new Promise(function(t,s){const o=[];["ui","config","user","system"].forEach(e=>{o.push=p(e)}),Promise.all(o).then(e=>{t(e)}).catch(e=>{console.error(e)})})},p=function(t){return new Promise(function(s,o){a(t).then(n=>{console.log(`${t} values loaded OK`),t==="user"&&m(n)}).catch(n=>{if(n==="emptyKey"){console.log(`No ${t} values found`);const e={};t==="user"?(e.user={},e.user.inputTokens=0,e.user.outputTokens=0,e.user.totalEmissions=0):t==="config"?(e.config={},e.config.charsPerToken={value:4,unit:"",label:"Characters Per Token"},e.config.gridFactor={value:383,unit:"gCO2e/kWh",label:"Grid Factor"},e.config.inputFactor={value:.002,unit:"kWh/token",label:"Input Token Factor"},e.config.outputFactor={value:.01,unit:"kWh/token",label:"Output Token Factor"},e.config.PUE={value:1.2,unit:"",label:"Power Usage Efficiency"}):t==="ui"?(e.ui={},e.ui.xPos="68%",e.ui.yPos="70%"):t==="system"&&(e.system={},e.system.chromeVersion=P()),f(e).then(c=>{console.log(`${t} values saved OK`),s(c)})}else console.error(n)})})};T();function E(t){let s,o=[0,0],n=!1;t.addEventListener("mousedown",function(e){n=!0,o=[t.offsetLeft-e.clientX,t.offsetTop-e.clientY]},!0),document.addEventListener("mouseup",function(){n=!1;const e={};e.ui={},e.ui.xPos=t.style.left,e.ui.yPos=t.style.top,f(e).then(c=>{console.log("ui position updated OK")})},!0),document.addEventListener("mousemove",function(e){e.preventDefault(),n&&(s={x:e.clientX,y:e.clientY},t.style.left=s.x+o[0]+"px",t.style.top=s.y+o[1]+"px")},!0)}function P(){var t=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return t?parseInt(t[2],10):!1}export{T as d,a as g,f as s};
