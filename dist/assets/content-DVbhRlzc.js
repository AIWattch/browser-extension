const u=function(t){return new Promise(function(c,o){try{chrome.storage.local.get([t]).then(n=>{Object.keys(n).length!==0?c(n[t]):o("emptyKey")})}catch(n){o(n)}})},l=function(t){return new Promise(function(c,o){try{chrome.storage.local.set(t).then(n=>{c(n)})}catch(n){o(n)}})},h=new MutationObserver((t,c)=>{for(const o of t)o.type==="childList"&&o.addedNodes.forEach(n=>{if(typeof n.className=="string"&&n.className==="fixed right-4 top-8 my-2 flex max-h-[90vh] flex-col-reverse space-y-2 space-y-reverse overflow-y-auto px-2 py-4"){const e=n.innerText.replace("ChatGPT",""),s=document.querySelectorAll("article"),i=s[s.length-2],r=[];r.push({type:"inputTokens",content:i.innerText}),r.push({type:"outputTokens",content:e}),g(r)}})});h.observe(document.body,{childList:!0,subtree:!0});function g(t){console.log("ChatGPT output finished");const c=[];t.forEach(o=>{const n=d(o);c.push(n)}),Promise.all(c).then(o=>{let n={};o.forEach(e=>{let s=Object.keys(e)[0],i=Object.values(e)[0];n[s]=i}),y(n).then(e=>e).then(e=>(l({user:e}),e)).then(e=>{f(e)})}).catch(o=>{console.error(o)})}const d=function(t){return new Promise(function(c,o){t.content;const n=t.content.length,e=t.type;u("config").then(s=>{const i=n/s.charsPerToken;u("user").then(r=>{const a=r[e],p=Math.ceil(a+i);c({[e]:p})})})})},y=function(t){return new Promise(function(c,o){const n=t.inputTokens,e=t.outputTokens;u("config").then(s=>(n*s.inputFactor+e*s.outputFactor)*s.PUE*s.gridFactor).then(s=>{t.totalEmissions=s,c(t)})})},T=function(){return new Promise(function(t,c){const o="user-stats",n=document.querySelector(`#${o}`);if(n){const e=n.querySelector("span");t([n,e])}else{const e=document.createElement("div"),s=document.createElement("span");e.id=o,e.insertAdjacentElement("afterbegin",s),document.body.insertAdjacentElement("afterbegin",e),t([e,s])}})};function f(t){window.location.href.startsWith("chrome-extension://")||T().then(c=>{const o=c[0],n=c[1];if(u("ui").then(s=>{o.style.top=s.yPos,o.style.left=s.xPos}).catch(s=>{s==="emptyKey"?m("ui"):console.error(s)}),k(o),n.textContent=`Input tokens: ${t.inputTokens} \r
`,n.textContent+=`Output tokens: ${t.outputTokens} \r
`,n.textContent+=`Total emissions: ${t.totalEmissions.toString().substring(0,6)}gCO2e \r
`,!document.querySelector(".reset-btn")){const s=document.createElement("img");s.className="reset-btn",s.src=chrome.runtime.getURL("../assets/reset.svg"),s.addEventListener("mouseup",function(i){const r={};r.user={},r.user.inputTokens=0,r.user.outputTokens=0,r.user.totalEmissions=0,l(r).then(a=>{console.log("cleared storage OK"),f(r.user)}).catch(a=>{console.log(a)})},!0),o.appendChild(s)}})}const E=function(){return new Promise(function(t,c){const o=[];["ui","config","user","system"].forEach(e=>{o.push=m(e)}),Promise.all(o).then(e=>{t(e)}).catch(e=>{console.error(e)})})},m=function(t){return new Promise(function(c,o){u(t).then(n=>{console.log(`${t} values loaded OK`),console.log(n),t==="user"&&f(n)}).catch(n=>{if(n==="emptyKey"){console.log(`No ${t} values found`);const e={};t==="user"?(e.user={},e.user.inputTokens=0,e.user.outputTokens=0,e.user.totalEmissions=0):t==="config"?(e.config={},e.config.charsPerToken=4,e.config.gridFactor=383,e.config.inputFactor=.014,e.config.outputFactor=.07,e.config.PUE=1.125):t==="ui"?(e.ui={},e.ui.xPos="68%",e.ui.yPos="70%"):t==="system"&&(e.system={},e.system.chromeVersion=P()),l(e).then(s=>{console.log(`${t} values saved OK`),c(s)})}else console.error(n)})})};E();function k(t){let c,o=[0,0],n=!1;t.addEventListener("mousedown",function(e){n=!0,o=[t.offsetLeft-e.clientX,t.offsetTop-e.clientY]},!0),document.addEventListener("mouseup",function(){n=!1;const e={};e.ui={},e.ui.xPos=t.style.left,e.ui.yPos=t.style.top,l(e).then(s=>{console.log("ui position updated OK")})},!0),document.addEventListener("mousemove",function(e){e.preventDefault(),n&&(c={x:e.clientX,y:e.clientY},t.style.left=c.x+o[0]+"px",t.style.top=c.y+o[1]+"px")},!0)}function P(){var t=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return t?parseInt(t[2],10):!1}export{E as d,u as g,l as s};
